<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VT Basketball Lineup Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, set, update, remove, get, runTransaction } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDnW_VGhEjObMYYRHGsEDo76EH9y3ebJgo",
      authDomain: "vtmbb-gameday.firebaseapp.com",
      databaseURL: "https://vtmbb-gameday-default-rtdb.firebaseio.com",
      projectId: "vtmbb-gameday",
      storageBucket: "vtmbb-gameday.firebasestorage.app",
      messagingSenderId: "1012073356538",
      appId: "1:1012073356538:web:7a41a93d00920d4d00bd43"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    window.firebaseDb = {
      ref: (path) => ref(database, path),
      set: (dbRef, value) => set(dbRef, value),
      update: (dbRef, value) => update(dbRef, value),
      remove: (dbRef) => remove(dbRef),
      get: (dbRef) => get(dbRef),
      runTransaction: (dbRef, updater) => runTransaction(dbRef, updater)
    };
  </script>
</head>
<body class="bg-gray-100">
  <div id="root"></div>

  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useMemo } = React;

    const gameSchedule = [
      { date: '2024-11-03', opponent: 'Charleston Southern', displayName: 'Nov 3 vs Charleston Southern' }
    ];

    const baseRoster = [
      { id: 0, name: 'Jailen Bedford', position: 'G' },
      { id: 1, name: 'Tobi Lawal', position: 'F' },
      { id: 2, name: 'Jaden Schutt', position: 'G' },
      { id: 3, name: 'Ben Hammond', position: 'G' },
      { id: 4, name: 'Izaiah Pasha', position: 'G' },
      { id: 5, name: 'Sin\'Cere Jones', position: 'F' },
      { id: 7, name: 'Brett Freeman', position: 'F' },
      { id: 10, name: 'Tyler Johnson', position: 'G' },
      { id: 13, name: 'Amani Hansberry', position: 'F' },
      { id: 15, name: 'Snook Peterkin', position: 'F' },
      { id: 17, name: 'Neo Avdalas', position: 'G' },
      { id: 22, name: 'Solomon Davis', position: 'F' },
      { id: 32, name: 'Christian Gurdak', position: 'C' },
      { id: 77, name: 'Antonio Dorn', position: 'C' }
    ];

    const sortedKey = (ids) => [...ids].map(Number).sort((a,b)=>a-b).join('-');

    function App() {
      const [dark, setDark] = useState(false);
      const [selectedGame, setSelectedGame] = useState('2024-11-03');
      const [gameStarted, setGameStarted] = useState(false);
      const [currentHalf, setCurrentHalf] = useState(1);
      const [gameTime, setGameTime] = useState('20:00');
      const [lineup, setLineup] = useState([3,2,17,1,13]);
      const rosterById = useMemo(() => {
        const m = new Map();
        baseRoster.forEach(p => m.set(p.id, p));
        return m;
      }, []);

      const writeGameInfo = async (payload) => {
        const r = window.firebaseDb.ref(`game-info/${selectedGame}`);
        await window.firebaseDb.update(r, payload);
      };

      const seedStats = async () => {
        await window.firebaseDb.set(window.firebaseDb.ref(`current-stats/${selectedGame}`), {
          vt: { possessions: 0, offensiveRebounds: 0, defensiveRebounds: 0, turnovers: 0 },
          opponent: { possessions: 0, offensiveRebounds: 0, defensiveRebounds: 0, turnovers: 0 }
        });
      };

      const seedLineupStatsIfMissing = async (ids) => {
        const key = sortedKey(ids);
        const ref = window.firebaseDb.ref(`lineup-stats/${selectedGame}/${key}`);
        const snap = await window.firebaseDb.get(ref);
        if (!snap.exists()) {
          await window.firebaseDb.set(ref, { ids, poss: 0, plusMinus: 0, turnovers: 0, teamReb: 0, oppReb: 0, lastUpdated: new Date().toISOString() });
        }
      };

      const startGame = async () => {
        setGameStarted(true);
        setCurrentHalf(1);
        setGameTime('20:00');

        const names = lineup.map(id => rosterById.get(id)?.name ?? String(id));
        await window.firebaseDb.set(window.firebaseDb.ref(`game-info/${selectedGame}`), {
          started: true,
          ended: false,
          currentHalf: 1,
          gameTime: '20:00',
          opponent: gameSchedule.find(g => g.date === selectedGame)?.opponent || 'Opponent',
          currentLineupIds: lineup,
          currentLineupNames: names,
          roster: baseRoster,
          startTime: new Date().toISOString()
        });

        await window.firebaseDb.remove(window.firebaseDb.ref(`lineup-changes/${selectedGame}`));
        await seedStats();
        await window.firebaseDb.set(window.firebaseDb.ref(`lineup-changes/${selectedGame}/game-start`), {
          timestamp: '20:00 1st', gameTime: '20:00 1st', ourScore: 0, oppScore: 0, change: 'Game Started', lineupIds: lineup, lineupNames: names, half: 1
        });
        await seedLineupStatsIfMissing(lineup);
      };

      const endGame = async () => {
        setGameStarted(false);
        await writeGameInfo({ ended: true, endTime: new Date().toISOString() });
      };

      const setActiveLineup = async (ids) => {
        const names = ids.map(id => rosterById.get(id)?.name ?? String(id));
        setLineup(ids);
        await writeGameInfo({ currentLineupIds: ids, currentLineupNames: names });
        await seedLineupStatsIfMissing(ids);
      };

      const togglePlayer = (id) => {
        const has = lineup.includes(id);
        let next = has ? lineup.filter(x => x !== id) : [...lineup, id];
        if (next.length > 5) next = next.slice(1);
        setLineup(next);
      };

      const commitLineup = async () => {
        if (!gameStarted) return;
        await setActiveLineup(lineup);
      };

      const bumpLineupStats = async (delta) => {
        const key = sortedKey(lineup);
        const ref = window.firebaseDb.ref(`lineup-stats/${selectedGame}/${key}`);
        const snap = await window.firebaseDb.get(ref);
        const prev = snap.val() || {};
        await window.firebaseDb.set(ref, {
          ids: lineup,
          poss: (prev.poss || 0) + (delta.poss || 0),
          plusMinus: (prev.plusMinus || 0) + (delta.plusMinus || 0),
          turnovers: (prev.turnovers || 0) + (delta.to || 0),
          teamReb: (prev.teamReb || 0) + (delta.teamReb || 0),
          oppReb: (prev.oppReb || 0) + (delta.oppReb || 0),
          lastUpdated: new Date().toISOString()
        });
      };

      const incField = async (path, delta) => {
        const r = window.firebaseDb.ref(path);
        await window.firebaseDb.runTransaction(r, (curr) => (Number(curr)||0) + delta);
      };

      const vt = (f, d) => incField(`current-stats/${selectedGame}/vt/${f}`, d);
      const opp = (f, d) => incField(`current-stats/${selectedGame}/opponent/${f}`, d);

      const onPossession = async () => {
        await vt('possessions', 1);
        await bumpLineupStats({ poss: 1 });
      };
      const onTurnover = async () => {
        await vt('turnovers', 1);
        await bumpLineupStats({ to: 1 });
      };
      const onOffReb = async () => {
        await vt('offensiveRebounds', 1);
        await bumpLineupStats({ teamReb: 1 });
      };
      const onDefRebOpp = async () => {
        await opp('defensiveRebounds', 1);
        await bumpLineupStats({ oppReb: 1 });
      };
      const onPlus = async (n) => { await bumpLineupStats({ plusMinus: n }); };
      const onMinus = async (n) => { await bumpLineupStats({ plusMinus: -n }); };

      const oppName = gameSchedule.find(g => g.date === selectedGame)?.opponent || 'Opponent';

      return (
        <div className={`min-h-screen p-4 ${dark ? 'bg-gray-900' : 'bg-gray-100'}`}>
          <div className="max-w-6xl mx-auto">
            <div className="flex justify-between items-center mb-6">
              <h1 className={`text-3xl font-bold ${dark ? 'text-white' : 'text-gray-900'}`}>VT Lineup Tracker</h1>
              <button onClick={()=>setDark(!dark)} className={`px-4 py-2 rounded ${dark?'bg-yellow-500 text-gray-900':'bg-gray-800 text-white'}`}>{dark?'Light':'Dark'}</button>
            </div>

            <div className={`rounded-lg p-4 mb-6 ${dark ? 'bg-gray-800' : 'bg-white'}`}>
              <div className="flex items-center gap-4">
                <label className={`${dark?'text-gray-300':'text-gray-700'} text-sm font-medium`}>Game</label>
                <select value={selectedGame} onChange={e=>setSelectedGame(e.target.value)} disabled={gameStarted}
                  className={`px-3 py-2 border rounded ${dark?'bg-gray-700 border-gray-600 text-white':'bg-white border-gray-300 text-gray-900'}`}>
                  {gameSchedule.map(g=> <option key={g.date} value={g.date}>{g.displayName}</option>)}
                </select>
                <div className="ml-auto flex gap-3">
                  {!gameStarted ? (
                    <button onClick={startGame} className="px-4 py-2 bg-green-600 text-white rounded">Start Game</button>
                  ) : (
                    <button onClick={endGame} className="px-4 py-2 bg-red-600 text-white rounded">End Game</button>
                  )}
                </div>
              </div>
              <div className={`${dark?'text-gray-300':'text-gray-600'} text-sm mt-2`}>
                Status: {gameStarted ? `Live vs ${oppName}` : 'Not Started'}
              </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div className={`rounded-lg p-4 ${dark ? 'bg-gray-800' : 'bg-white'}`}>
                <div className={`text-xl font-semibold mb-3 ${dark?'text-white':'text-gray-900'}`}>Select Lineup (5)</div>
                <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                  {baseRoster.map(p=>{
                    const active = lineup.includes(p.id);
                    return (
                      <button key={p.id} onClick={()=>togglePlayer(p.id)}
                        className={`px-3 py-2 rounded text-sm ${active? 'bg-blue-600 text-white':'bg-gray-200 text-gray-800'}`}>
                        #{p.id} {p.name} ({p.position})
                      </button>
                    );
                  })}
                </div>
                <div className="mt-3 flex gap-2">
                  <button onClick={commitLineup} disabled={!gameStarted} className={`px-4 py-2 rounded ${gameStarted?'bg-blue-600 text-white':'bg-gray-300 text-gray-600'}`}>Set Active Lineup</button>
                </div>
              </div>

              <div className={`rounded-lg p-4 ${dark ? 'bg-gray-800' : 'bg-white'}`}>
                <div className={`text-xl font-semibold mb-3 ${dark?'text-white':'text-gray-900'}`}>Events</div>
                <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                  <button onClick={onPossession} disabled={!gameStarted} className="px-3 py-2 bg-gray-200 rounded">VT + Possession</button>
                  <button onClick={onTurnover} disabled={!gameStarted} className="px-3 py-2 bg-gray-200 rounded">VT + Turnover</button>
                  <button onClick={onOffReb} disabled={!gameStarted} className="px-3 py-2 bg-gray-200 rounded">VT + Off Reb</button>
                  <button onClick={onDefRebOpp} disabled={!gameStarted} className="px-3 py-2 bg-gray-200 rounded">Opp + Def Reb</button>
                  <button onClick={()=>onPlus(1)} disabled={!gameStarted} className="px-3 py-2 bg-green-200 rounded">VT +1 +/-</button>
                  <button onClick={()=>onMinus(1)} disabled={!gameStarted} className="px-3 py-2 bg-red-200 rounded">VT -1 +/-</button>
                  <button onClick={()=>onPlus(2)} disabled={!gameStarted} className="px-3 py-2 bg-green-200 rounded">VT +2 +/-</button>
                  <button onClick={()=>onMinus(2)} disabled={!gameStarted} className="px-3 py-2 bg-red-200 rounded">VT -2 +/-</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
