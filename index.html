<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VT Basketball Lineup Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, update, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyDnW_VGhEjObMYYRHGsEDo76EH9y3ebJgo",
            authDomain: "vtmbb-gameday.firebaseapp.com",
            databaseURL: "https://vtmbb-gameday-default-rtdb.firebaseio.com",
            projectId: "vtmbb-gameday",
            storageBucket: "vtmbb-gameday.firebasestorage.app",
            messagingSenderId: "1012073356538",
            appId: "1:1012073356538:web:7a41a93d00920d4d00bd43"
        };
        
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        window.firebaseDb = {
            ref: (path) => ref(database, path),
            set: (dbRef, value) => set(dbRef, value),
            update: (dbRef, value) => update(dbRef, value),
            remove: (dbRef) => remove(dbRef)
        };
        
        console.log('Firebase initialized successfully');
    </script>
</head>
<body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const BasketballLineupTracker = () => {
            const [darkMode, setDarkMode] = useState(false);
            const [selectedGame, setSelectedGame] = useState('2024-11-03');
            const [gameStarted, setGameStarted] = useState(false);
            const [gameEnded, setGameEnded] = useState(false);
            const [currentHalf, setCurrentHalf] = useState(1);
            const [gameTime, setGameTime] = useState('20:00');
            const [lastSubTime, setLastSubTime] = useState(null);
            const [currentLineup, setCurrentLineup] = useState([3, 2, 17, 1, 13]);
            const [playerStatus, setPlayerStatus] = useState({
                0: false, 1: true, 2: true, 3: true, 4: false, 5: false,
                7: false, 10: false, 13: true, 15: false, 17: true, 22: false, 32: false, 77: false
            });
            const [pendingChanges, setPendingChanges] = useState([]);
            const [showTimeScoreModal, setShowTimeScoreModal] = useState(false);
            const [pendingGameTime, setPendingGameTime] = useState('');
            const [ourScore, setOurScore] = useState('');
            const [oppScore, setOppScore] = useState('');
            const [lineupHistory, setLineupHistory] = useState([]);
            const [currentStats, setCurrentStats] = useState({
                vt: {
                    possessions: 0,
                    offensiveRebounds: 0,
                    defensiveRebounds: 0,
                    turnovers: 0
                },
                opponent: {
                    possessions: 0,
                    offensiveRebounds: 0,
                    defensiveRebounds: 0,
                    turnovers: 0
                }
            });

            useEffect(() => {
                document.body.className = darkMode ? 'bg-gray-900' : 'bg-gray-100';
            }, [darkMode]);

            const gameSchedule = [
                { 
                    date: '2024-11-03', 
                    opponent: 'Charleston Southern',
                    displayName: 'Nov 3 vs Charleston Southern'
                }
            ];

            const roster = [
                { id: 0, name: 'Jailen Bedford', position: 'G', onCourt: false },
                { id: 1, name: 'Tobi Lawal', position: 'F', onCourt: true },
                { id: 2, name: 'Jaden Schutt', position: 'G', onCourt: true },
                { id: 3, name: 'Ben Hammond', position: 'G', onCourt: true },
                { id: 4, name: 'Izaiah Pasha', position: 'G', onCourt: false },
                { id: 5, name: 'Sin\'Cere Jones', position: 'F', onCourt: false },
                { id: 7, name: 'Brett Freeman', position: 'F', onCourt: false },
                { id: 10, name: 'Tyler Johnson', position: 'G', onCourt: false },
                { id: 13, name: 'Amani Hansberry', position: 'F', onCourt: true },
                { id: 15, name: 'Snook Peterkin', position: 'F', onCourt: false },
                { id: 17, name: 'Neo Avdalas', position: 'G', onCourt: true },
                { id: 22, name: 'Solomon Davis', position: 'F', onCourt: false },
                { id: 32, name: 'Christian Gurdak', position: 'C', onCourt: false },
                { id: 77, name: 'Antonio Dorn', position: 'C', onCourt: false }
            ];

            const startGame = async () => {
                console.log('Starting game...');
                setGameStarted(true);
                setGameEnded(false);
                setCurrentHalf(1);
                setGameTime('20:00');
                setLastSubTime(null);
                
                if (window.firebaseDb) {
                    try {
                        const initialLineup = currentLineup.map(id => roster.find(p => p.id === id)?.name).join(', ');
                        
                        // Update gameday Firebase
                        const gameInfoRef = window.firebaseDb.ref(`game-info/${selectedGame}`);
                        await window.firebaseDb.set(gameInfoRef, {
                            started: true,
                            ended: false,
                            currentHalf: 1,
                            gameTime: '20:00',
                            opponent: gameSchedule.find(g => g.date === selectedGame)?.opponent || 'Opponent',
                            currentLineup: initialLineup,
                            startTime: new Date().toISOString()
                        });
                        
                        const changesRef = window.firebaseDb.ref(`lineup-changes/${selectedGame}`);
                        await window.firebaseDb.remove(changesRef);
                        
                        const statsRef = window.firebaseDb.ref(`current-stats/${selectedGame}`);
                        await window.firebaseDb.set(statsRef, {
                            vt: { possessions: 0, offensiveRebounds: 0, defensiveRebounds: 0, turnovers: 0 },
                            opponent: { possessions: 0, offensiveRebounds: 0, defensiveRebounds: 0, turnovers: 0 }
                        });
                        
                        const startRef = window.firebaseDb.ref(`lineup-changes/${selectedGame}/game-start`);
                        await window.firebaseDb.set(startRef, {
                            timestamp: '20:00 1st',
                            gameTime: '20:00 1st',
                            ourScore: 0,
                            oppScore: 0,
                            change: 'Game Started',
                            lineup: initialLineup,
                            half: 1
                        });
                        
                        // Update hustle chart Firebase with game live status
                        try {
                            const response = await fetch('https://vtmbb-hustle-chart-default-rtdb.firebaseio.com/gameStatus.json', {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    isLive: true,
                                    currentGame: selectedGame,
                                    opponent: gameSchedule.find(g => g.date === selectedGame)?.opponent || 'Opponent',
                                    startTime: new Date().toISOString(),
                                    lastUpdated: new Date().toISOString()
                                })
                            });
                            
                            if (response.ok) {
                                console.log('Game live status updated in hustle chart Firebase');
                            } else {
                                console.error('Failed to update hustle chart Firebase');
                            }
                        } catch (error) {
                            console.error('Error updating hustle chart Firebase:', error);
                        }
                        
                        console.log('Game started successfully');
                    } catch (error) {
                        console.error('Error starting game:', error);
                    }
                }
            };

            const endGame = async () => {
                setGameStarted(false);
                setGameEnded(true);
                
                if (window.firebaseDb) {
                    // Update gameday Firebase
                    const gameInfoRef = window.firebaseDb.ref(`game-info/${selectedGame}`);
                    await window.firebaseDb.update(gameInfoRef, {
                        ended: true,
                        endTime: new Date().toISOString()
                    });
                    
                    // Update hustle chart Firebase to set game as no longer live
                    try {
                        const response = await fetch('https://vtmbb-hustle-chart-default-rtdb.firebaseio.com/gameStatus.json', {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                isLive: false,
                                currentGame: null,
                                opponent: null,
                                endTime: new Date().toISOString(),
                                lastUpdated: new Date().toISOString()
                            })
                        });
                        
                        if (response.ok) {
                            console.log('Game live status cleared in hustle chart Firebase');
                        } else {
                            console.error('Failed to clear game live status in hustle chart Firebase');
                        }
                    } catch (error) {
                        console.error('Error clearing game live status:', error);
                    }
                }
            };

            const currentOpponent = gameSchedule.find(game => game.date === selectedGame)?.opponent || 'Opponent';

            return (
                <div className={`min-h-screen p-4 ${darkMode ? 'bg-gray-900' : 'bg-gray-100'}`}>
                    <div className="max-w-6xl mx-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h1 className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                                VT Basketball Lineup Tracker
                            </h1>
                            <button
                                onClick={() => setDarkMode(!darkMode)}
                                className={`px-4 py-2 rounded-md ${
                                    darkMode 
                                        ? 'bg-yellow-500 text-gray-900 hover:bg-yellow-600' 
                                        : 'bg-gray-800 text-white hover:bg-gray-700'
                                }`}
                            >
                                {darkMode ? 'Light' : 'Dark'}
                            </button>
                        </div>

                        <div className={`rounded-lg shadow-lg p-4 mb-6 ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-4">
                                    <label className={`text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                        Select Game:
                                    </label>
                                    <select
                                        value={selectedGame}
                                        onChange={(e) => setSelectedGame(e.target.value)}
                                        disabled={gameStarted}
                                        className={`px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 ${
                                            gameStarted ? 'opacity-50 cursor-not-allowed' : ''
                                        } ${
                                            darkMode 
                                                ? 'bg-gray-700 border-gray-600 text-white' 
                                                : 'bg-white border-gray-300 text-gray-900'
                                        }`}
                                    >
                                        {gameSchedule.map(game => (
                                            <option key={game.date} value={game.date}>
                                                {game.displayName}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                                
                                <div className="flex items-center gap-3">
                                    {gameStarted && (
                                        <div className={`text-sm ${darkMode ? 'text-green-400' : 'text-green-600'}`}>
                                            <div className="flex items-center gap-2">
                                                <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                                <div>Game Live</div>
                                            </div>
                                        </div>
                                    )}
                                    
                                    {!gameStarted ? (
                                        <button
                                            onClick={startGame}
                                            className="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 font-medium"
                                        >
                                            Start Game
                                        </button>
                                    ) : (
                                        <button
                                            onClick={endGame}
                                            className="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 font-medium"
                                        >
                                            End Game
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>
                        
                        <div className={`rounded-lg shadow-lg p-6 ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                            <h2 className={`text-xl font-semibold mb-4 text-center ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                                Game Status: {gameStarted ? `Live vs ${currentOpponent}` : 'Not Started'}
                            </h2>
                            {gameStarted && (
                                <p className={`text-center ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                                    This will write the live game status to both Firebase databases
                                </p>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<BasketballLineupTracker />);
    </script>
</body>
</html>
