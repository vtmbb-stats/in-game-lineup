<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VT Basketball Combo Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyDnW_VGhEjObMYYRHGsEDo76EH9y3ebJgo",
            authDomain: "vtmbb-gameday.firebaseapp.com",
            databaseURL: "https://vtmbb-gameday-default-rtdb.firebaseio.com",
            projectId: "vtmbb-gameday",
            storageBucket: "vtmbb-gameday.firebasestorage.app",
            messagingSenderId: "1012073356538",
            appId: "1:1012073356538:web:7a41a93d00920d4d00bd43"
        };
        
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        window.firebaseDb = {
            ref: (path) => ref(database, path),
            onValue: (dbRef, callback) => onValue(dbRef, callback)
        };
        
        console.log('Firebase initialized successfully');
    </script>
</head>
<body>
    <div id="root"></div>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const ComboAnalysisViewer = () => {
            const [darkMode, setDarkMode] = useState(true);
            const [startGame, setStartGame] = useState('2025-10-11');
            const [endGame, setEndGame] = useState('2025-12-20');
            const [loading, setLoading] = useState(true);
            const [allGamesData, setAllGamesData] = useState({});
            const [gamesWithData, setGamesWithData] = useState([]);
            const [twoCombos, setTwoCombos] = useState([]);
            const [threeCombos, setThreeCombos] = useState([]);

            const roster = [
                { id: 0, name: 'Jailen Bedford', position: 'G' },
                { id: 1, name: 'Tobi Lawal', position: 'F' },
                { id: 2, name: 'Jaden Schutt', position: 'G' },
                { id: 3, name: 'Ben Hammond', position: 'G' },
                { id: 4, name: 'Izaiah Pasha', position: 'G' },
                { id: 5, name: 'Sin\'Cere Jones', position: 'F' },
                { id: 7, name: 'Brett Freeman', position: 'F' },
                { id: 10, name: 'Tyler Johnson', position: 'G' },
                { id: 13, name: 'Amani Hansberry', position: 'F' },
                { id: 15, name: 'Snook Peterkin', position: 'F' },
                { id: 17, name: 'Neo Avdalas', position: 'G' },
                { id: 22, name: 'Solomon Davis', position: 'F' },
                { id: 32, name: 'Christian Gurdak', position: 'C' },
                { id: 77, name: 'Antonio Dorn', position: 'C' }
            ];

            const gameSchedule = [
                { date: '2025-10-11', opponent: 'Seton Hall', displayName: 'Oct 11 vs Seton Hall' },
                { date: '2025-10-25', opponent: 'Duquesne', displayName: 'Oct 25 vs Duquesne' },
                { date: '2025-11-03', opponent: 'Charleston Southern', displayName: 'Nov 4 vs Charleston Southern' },
                { date: '2025-11-08', opponent: 'Providence', displayName: 'Nov 8 vs Providence' },
                { date: '2025-11-12', opponent: 'Saint Joseph\'s', displayName: 'Nov 12 vs Saint Joseph\'s' },
                { date: '2025-11-16', opponent: 'Charlotte', displayName: 'Nov 16 vs Charlotte' },
                { date: '2025-11-19', opponent: 'Bryant', displayName: 'Nov 19 vs Bryant' },
                { date: '2025-11-26', opponent: 'Colorado State', displayName: 'Nov 26 vs Colorado State' },
                { date: '2025-12-02', opponent: 'South Carolina', displayName: 'Dec 2 vs South Carolina' },
                { date: '2025-12-06', opponent: 'George Mason', displayName: 'Dec 6 vs George Mason' },
                { date: '2025-12-11', opponent: 'Western Carolina', displayName: 'Dec 11 vs Western Carolina' },
                { date: '2025-12-14', opponent: 'Maryland-Eastern Shore', displayName: 'Dec 14 vs Maryland-Eastern Shore' },
                { date: '2025-12-20', opponent: 'Elon', displayName: 'Dec 20 vs Elon' }
            ];

            useEffect(() => { loadAllGames(); }, []);
            useEffect(() => {
                if (!loading) calculateCombos();
            }, [startGame, endGame, loading]);

            const loadAllGames = async () => {
                if (!window.firebaseDb) return;
                setLoading(true);
                const gamesData = {}, gamesFound = [];
                for (const game of gameSchedule) {
                    const gameInfoRef = window.firebaseDb.ref(`game-info/${game.date}`);
                    await new Promise((resolve) => {
                        window.firebaseDb.onValue(gameInfoRef, async (snapshot) => {
                            if (snapshot.exists()) {
                                const gameInfo = snapshot.val();
                                if (gameInfo.ended) {
                                    const lineupChangesRef = window.firebaseDb.ref(`lineup-changes/${game.date}`);
                                    await new Promise((resolveLineup) => {
                                        window.firebaseDb.onValue(lineupChangesRef, (lineupSnapshot) => {
                                            if (lineupSnapshot.exists()) {
                                                gamesData[game.date] = Object.values(lineupSnapshot.val());
                                                gamesFound.push(game.date);
                                            }
                                            resolveLineup();
                                        }, { onlyOnce: true });
                                    });
                                }
                            }
                            resolve();
                        }, { onlyOnce: true });
                    });
                }
                setAllGamesData(gamesData);
                setGamesWithData(gamesFound);
                if (gamesFound.length > 0) {
                    setStartGame(gamesFound[0]);
                    setEndGame(gamesFound[gamesFound.length - 1]);
                }
                setLoading(false);
            };

            const buildSegments = (lineupHistory) => {
                const segments = [];
                const sortedHistory = [...lineupHistory].sort((a, b) => {
                    const parseTime = (t) => {
                        const m = t.match(/(\d+):(\d+)\s+(1st|2nd|OT)/);
                        if (!m) return 0;
                        const p = m[3] === '1st' ? 0 : m[3] === '2nd' ? 1 : 2;
                        return p * 100000 + ((20 * 60) - (parseInt(m[1]) * 60 + parseInt(m[2])));
                    };
                    return parseTime(a.timestamp || a.gameTime || '') - parseTime(b.timestamp || b.gameTime || '');
                });
                const realChanges = sortedHistory.filter(r => r.changes !== 'End of 1st Half');
                const endOf1stHalf = sortedHistory.find(r => r.changes === 'End of 1st Half');
                if (realChanges.length === 0) return segments;
                const firstChange = realChanges[0];
                const isStartOf2ndHalf = firstChange.changes === 'Start of 2nd Half';
                if (!isStartOf2ndHalf) {
                    const firstLineup = firstChange.previousLineup ? firstChange.previousLineup.split(', ').map(n => roster.find(p => p.name === n)?.id).filter(id => id !== undefined) : [];
                    if (firstLineup.length === 5) {
                        segments.push({ lineup: firstLineup, startScore: { vt: 0, opp: 0 }, endScore: { vt: firstChange.vtScore, opp: firstChange.oppScore }, startTime: '20:00 1st', endTime: firstChange.gameTime });
                    }
                }
                for (let i = 1; i < realChanges.length; i++) {
                    const thisChange = realChanges[i], prevChange = realChanges[i - 1];
                    const segmentLineup = prevChange.newLineup ? prevChange.newLineup.split(', ').map(n => roster.find(p => p.name === n)?.id).filter(id => id !== undefined) : [];
                    if (segmentLineup.length === 5) {
                        segments.push({ lineup: segmentLineup, startScore: { vt: prevChange.vtScore, opp: prevChange.oppScore }, endScore: { vt: thisChange.vtScore, opp: thisChange.oppScore }, startTime: prevChange.gameTime, endTime: thisChange.gameTime });
                    }
                }
                if (!isStartOf2ndHalf && realChanges.length > 0) {
                    const lastChange = realChanges[realChanges.length - 1];
                    const lastLineup = lastChange.newLineup ? lastChange.newLineup.split(', ').map(n => roster.find(p => p.name === n)?.id).filter(id => id !== undefined) : [];
                    if (lastLineup.length === 5 && endOf1stHalf && lastChange.half === 1) {
                        segments.push({ lineup: lastLineup, startScore: { vt: lastChange.vtScore, opp: lastChange.oppScore }, endScore: { vt: endOf1stHalf.vtScore, opp: endOf1stHalf.oppScore }, startTime: lastChange.gameTime, endTime: '0:00 1st' });
                    }
                }
                return segments;
            };

            const calculateMinutesPlayed = (startTime, endTime) => {
                if (endTime === 'Current') return 0;
                const parse = (t) => {
                    const m = t.match(/(\d+):(\d+)\s+(1st|2nd|OT)/);
                    return m ? { totalSeconds: parseInt(m[1]) * 60 + parseInt(m[2]), period: m[3] } : null;
                };
                const start = parse(startTime), end = parse(endTime);
                if (!start || !end) return 0;
                let playedSeconds;
                if (start.period !== end.period) {
                    playedSeconds = start.totalSeconds + ((20 * 60) - end.totalSeconds);
                } else if (startTime === '20:00 1st') {
                    playedSeconds = (20 * 60) - end.totalSeconds;
                } else {
                    playedSeconds = start.totalSeconds - end.totalSeconds;
                }
                return playedSeconds < 0 ? 0 : playedSeconds;
            };

            const calculateCombos = () => {
                const startIdx = gameSchedule.findIndex(g => g.date === startGame);
                const endIdx = gameSchedule.findIndex(g => g.date === endGame);
                if (startIdx === -1 || endIdx === -1 || startIdx > endIdx) {
                    setTwoCombos([]);
                    setThreeCombos([]);
                    return;
                }
                const gamesToInclude = gameSchedule.slice(startIdx, endIdx + 1);
                const twoPlayerMap = new Map();
                const threePlayerMap = new Map();

                gamesToInclude.forEach(game => {
                    const gameHistory = allGamesData[game.date];
                    if (!gameHistory) return;
                    const segments = buildSegments(gameHistory);
                    
                    segments.forEach(segment => {
                        const vtPoints = segment.endScore.vt - segment.startScore.vt;
                        const oppPoints = segment.endScore.opp - segment.startScore.opp;
                        const plusMinus = vtPoints - oppPoints;
                        const minutesSeconds = calculateMinutesPlayed(segment.startTime, segment.endTime);
                        
                        const lineup = segment.lineup;
                        for (let i = 0; i < lineup.length; i++) {
                            for (let j = i + 1; j < lineup.length; j++) {
                                const pair = [lineup[i], lineup[j]].sort((a, b) => a - b);
                                const key = pair.join('-');
                                if (!twoPlayerMap.has(key)) {
                                    twoPlayerMap.set(key, { players: pair, totalPlusMinus: 0, totalSeconds: 0 });
                                }
                                const combo = twoPlayerMap.get(key);
                                combo.totalPlusMinus += plusMinus;
                                combo.totalSeconds += minutesSeconds;
                            }
                        }
                        
                        for (let i = 0; i < lineup.length; i++) {
                            for (let j = i + 1; j < lineup.length; j++) {
                                for (let k = j + 1; k < lineup.length; k++) {
                                    const trio = [lineup[i], lineup[j], lineup[k]].sort((a, b) => a - b);
                                    const key = trio.join('-');
                                    if (!threePlayerMap.has(key)) {
                                        threePlayerMap.set(key, { players: trio, totalPlusMinus: 0, totalSeconds: 0 });
                                    }
                                    const combo = threePlayerMap.get(key);
                                    combo.totalPlusMinus += plusMinus;
                                    combo.totalSeconds += minutesSeconds;
                                }
                            }
                        }
                    });
                });

                const minSeconds = 5 * 60;
                const processCombos = (comboMap) => {
                    return Array.from(comboMap.values())
                        .filter(c => c.totalSeconds >= minSeconds)
                        .map(c => {
                            const totalMins = c.totalSeconds / 60;
                            const pmPerMin = c.totalPlusMinus / totalMins;
                            const names = c.players.map(id => roster.find(p => p.id === id)?.name.split(' ').pop() || '').join(', ');
                            return {
                                names,
                                totalPlusMinus: c.totalPlusMinus,
                                totalMinutes: totalMins,
                                pmPerMinute: pmPerMin
                            };
                        })
                        .sort((a, b) => b.pmPerMinute - a.pmPerMinute);
                };

                setTwoCombos(processCombos(twoPlayerMap));
                setThreeCombos(processCombos(threePlayerMap));
            };

            if (loading) {
                return (
                    <div className={`min-h-screen flex items-center justify-center ${darkMode ? 'bg-gray-900' : 'bg-gray-100'}`}>
                        <div className={`text-xl ${darkMode ? 'text-white' : 'text-gray-900'}`}>Loading season data...</div>
                    </div>
                );
            }

            const top5Twos = twoCombos.slice(0, 5);
            const bottom5Twos = twoCombos.slice(-5).reverse();
            const top5Threes = threeCombos.slice(0, 5);
            const bottom5Threes = threeCombos.slice(-5).reverse();

            return (
                <div className={`min-h-screen ${darkMode ? 'bg-gray-900' : 'bg-gray-100'}`}>
                    <div className="p-4 border-b border-gray-300 dark:border-gray-700">
                        <div className="flex justify-between items-center">
                            <h1 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>VT Basketball Combo Analysis</h1>
                            <div className="flex items-center gap-4">
                                <div className="flex items-center gap-2">
                                    <label className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>From:</label>
                                    <select value={startGame} onChange={(e) => setStartGame(e.target.value)} className={`px-3 py-2 border rounded-md ${darkMode ? 'bg-gray-800 border-gray-600 text-white' : 'bg-white border-gray-300 text-gray-900'}`}>
                                        {gameSchedule.filter(g => gamesWithData.includes(g.date)).map(game => (<option key={game.date} value={game.date}>{game.displayName}</option>))}
                                    </select>
                                </div>
                                <div className="flex items-center gap-2">
                                    <label className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>To:</label>
                                    <select value={endGame} onChange={(e) => setEndGame(e.target.value)} className={`px-3 py-2 border rounded-md ${darkMode ? 'bg-gray-800 border-gray-600 text-white' : 'bg-white border-gray-300 text-gray-900'}`}>
                                        {gameSchedule.filter(g => gamesWithData.includes(g.date)).map(game => (<option key={game.date} value={game.date}>{game.displayName}</option>))}
                                    </select>
                                </div>
                                <button onClick={() => setDarkMode(!darkMode)} className={`px-4 py-2 rounded-md ${darkMode ? 'bg-yellow-500 text-gray-900' : 'bg-gray-800 text-white'}`}>{darkMode ? 'Light' : 'Dark'}</button>
                            </div>
                        </div>
                    </div>

                    <div className="p-6 space-y-8">
                        <div>
                            <h2 className={`text-2xl font-bold mb-4 text-center ${darkMode ? 'text-white' : 'text-gray-900'}`}>2-Player Combos</h2>
                            <div className="grid grid-cols-2 gap-6">
                                <div>
                                    <h3 className={`text-xl font-semibold mb-3 ${darkMode ? 'text-green-400' : 'text-green-600'}`}>Top 5 2s</h3>
                                    <div className="space-y-3">
                                        {top5Twos.map((combo, idx) => (
                                            <div key={idx} className={`p-4 rounded-lg ${darkMode ? 'bg-gray-800' : 'bg-white'} shadow`}>
                                                <div className={`font-bold text-lg ${darkMode ? 'text-white' : 'text-gray-900'}`}>{combo.names}</div>
                                                <div className="flex justify-between mt-2">
                                                    <span className={`text-green-500 font-semibold`}>+{combo.totalPlusMinus} ({combo.pmPerMinute.toFixed(2)}/min)</span>
                                                    <span className={`${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{combo.totalMinutes.toFixed(1)} min</span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div>
                                    <h3 className={`text-xl font-semibold mb-3 ${darkMode ? 'text-red-400' : 'text-red-600'}`}>Bottom 5 2s</h3>
                                    <div className="space-y-3">
                                        {bottom5Twos.map((combo, idx) => (
                                            <div key={idx} className={`p-4 rounded-lg ${darkMode ? 'bg-gray-800' : 'bg-white'} shadow`}>
                                                <div className={`font-bold text-lg ${darkMode ? 'text-white' : 'text-gray-900'}`}>{combo.names}</div>
                                                <div className="flex justify-between mt-2">
                                                    <span className={`text-red-500 font-semibold`}>{combo.totalPlusMinus} ({combo.pmPerMinute.toFixed(2)}/min)</span>
                                                    <span className={`${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{combo.totalMinutes.toFixed(1)} min</span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h2 className={`text-2xl font-bold mb-4 text-center ${darkMode ? 'text-white' : 'text-gray-900'}`}>3-Player Combos</h2>
                            <div className="grid grid-cols-2 gap-6">
                                <div>
                                    <h3 className={`text-xl font-semibold mb-3 ${darkMode ? 'text-green-400' : 'text-green-600'}`}>Top 5 3s</h3>
                                    <div className="space-y-3">
                                        {top5Threes.map((combo, idx) => (
                                            <div key={idx} className={`p-4 rounded-lg ${darkMode ? 'bg-gray-800' : 'bg-white'} shadow`}>
                                                <div className={`font-bold text-lg ${darkMode ? 'text-white' : 'text-gray-900'}`}>{combo.names}</div>
                                                <div className="flex justify-between mt-2">
                                                    <span className={`text-green-500 font-semibold`}>+{combo.totalPlusMinus} ({combo.pmPerMinute.toFixed(2)}/min)</span>
                                                    <span className={`${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{combo.totalMinutes.toFixed(1)} min</span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div>
                                    <h3 className={`text-xl font-semibold mb-3 ${darkMode ? 'text-red-400' : 'text-red-600'}`}>Bottom 5 3s</h3>
                                    <div className="space-y-3">
                                        {bottom5Threes.map((combo, idx) => (
                                            <div key={idx} className={`p-4 rounded-lg ${darkMode ? 'bg-gray-800' : 'bg-white'} shadow`}>
                                                <div className={`font-bold text-lg ${darkMode ? 'text-white' : 'text-gray-900'}`}>{combo.names}</div>
                                                <div className="flex justify-between mt-2">
                                                    <span className={`text-red-500 font-semibold`}>{combo.totalPlusMinus} ({combo.pmPerMinute.toFixed(2)}/min)</span>
                                                    <span className={`${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{combo.totalMinutes.toFixed(1)} min</span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className={`rounded-lg shadow p-6 ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                            <h2 className={`text-2xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-900'}`}>Opponent-Weighted Lineup Scores</h2>
                            <div className={`text-center py-12 ${darkMode ? 'text-gray-400' : 'text-gray-500'} text-lg`}>
                                Opponent strengths not available yet
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ComboAnalysisViewer />);
    </script>
</body>
</html>
